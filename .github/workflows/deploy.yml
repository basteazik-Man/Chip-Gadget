name: Deploy to Beget

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: |
        npm ci --legacy-peer-deps
        echo "âœ… Dependencies installed"
    
    - name: Build project
      run: |
        npm run build
        echo "âœ… Build completed"
    
    - name: Verify PWA files
      run: |
        cd dist
        echo "ðŸ“ Files in dist after build:"
        ls -la
        
        echo -e "\nðŸ” Looking for PWA files:"
        find . -name "*.js" -o -name "*.webmanifest" -o -name "*.html" | xargs grep -l "manifest\|register\|service-worker" 2>/dev/null || echo "No PWA files found"
        
        echo -e "\nðŸ“„ Checking for generated files:"
        [ -f "manifest.webmanifest" ] && echo "âœ… manifest.webmanifest exists" || echo "âŒ manifest.webmanifest missing"
        [ -f "registerSW.js" ] && echo "âœ… registerSW.js exists" || echo "âŒ registerSW.js missing"
    
    - name: Create .htaccess for Beget
      run: |
        cd dist
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¹ .htaccess Ð´Ð»Ñ Beget Ñ PWA
        cat > .htaccess << 'EOF'
# ============================================
# React Vite PWA Configuration for Beget
# ============================================

RewriteEngine On
RewriteBase /

# Serve existing files and directories
RewriteCond %{REQUEST_FILENAME} -f [OR]
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule ^ - [L]

# SPA fallback
RewriteRule ^ index.html [L]

# ========== MIME TYPES FOR VITE PWA ==========
# JavaScript
AddType application/javascript          .js
AddType application/javascript          .mjs
AddType application/wasm                .wasm

# CSS
AddType text/css                        .css

# Images
AddType image/jpeg                      .jpeg .jpg
AddType image/png                       .png
AddType image/gif                       .gif
AddType image/svg+xml                   .svg
AddType image/webp                      .webp
AddType image/x-icon                    .ico

# Data
AddType application/json                .json
AddType application/manifest+json       .webmanifest
AddType application/xml                 .xml
AddType text/xml                        .xml

# Fonts
AddType font/woff                       .woff
AddType font/woff2                      .woff2
AddType application/vnd.ms-fontobject   .eot
AddType font/ttf                        .ttf
AddType font/otf                        .otf

# ========== SECURITY & PERFORMANCE ==========
# Disable directory listing
Options -Indexes

# Prevent access to .htaccess
<Files .htaccess>
  Order allow,deny
  Deny from all
</Files>

# Security headers (optional)
<IfModule mod_headers.c>
  Header set X-Content-Type-Options "nosniff"
  Header set X-Frame-Options "SAMEORIGIN"
  Header set X-XSS-Protection "1; mode=block"
</IfModule>
EOF
        
        echo "âœ… .htaccess created"
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ
        echo -e "\nðŸ“„ .htaccess content:"
        head -30 .htaccess
    
    - name: Create _redirects for SPA
      run: |
        cd dist
        echo "/*    /index.html   200" > _redirects
        echo "âœ… _redirects created"
    
    - name: Deploy to Beget via FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.0
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./dist/
        server-dir: ${{ secrets.FTP_DIR }}
        dangerous-clean-slate: false
        exclude: |
          **/.git*
          **/.git*/**
          **/.DS_Store