name: Deploy to Beget

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Install dependencies
      run: npm install
    
    - name: Build project (Vite)
      run: npm run build
      
    - name: Create CORRECT .htaccess file
      run: |
        cd dist
        echo '# Правила для React Vite на Beget
        RewriteEngine On
        RewriteBase /
        
        # Существующие файлы отдаем как есть
        RewriteCond %{REQUEST_FILENAME} -f [OR]
        RewriteCond %{REQUEST_FILENAME} -d
        RewriteRule ^ - [L]
        
        # Все остальное на index.html
        RewriteRule ^ index.html [L]
        
        # КРИТИЧНО: Правильные MIME-типы для Vite
        AddType application/javascript          .js
        AddType application/javascript          .mjs
        AddType application/wasm                .wasm
        AddType text/css                        .css
        AddType application/json                .json
        AddType image/svg+xml                   .svg
        AddType application/manifest+json       .webmanifest
        
        # Кэширование для производительности
        <IfModule mod_expires.c>
          ExpiresActive On
          ExpiresByType image/jpg "access plus 1 year"
          ExpiresByType image/jpeg "access plus 1 year"
          ExpiresByType image/gif "access plus 1 year"
          ExpiresByType image/png "access plus 1 year"
          ExpiresByType image/svg+xml "access plus 1 year"
          ExpiresByType text/css "access plus 1 month"
          ExpiresByType application/javascript "access plus 1 month"
        </IfModule>' > .htaccess
        
        # Создаем _redirects для надежности
        echo '/*    /index.html   200' > _redirects
    
    - name: Check files in dist
      run: |
        cd dist
        ls -la
        echo "=== .htaccess content ==="
        cat .htaccess
    
    - name: Deploy to Beget via FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.0
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./dist/
        server-dir: ${{ secrets.FTP_DIR }}