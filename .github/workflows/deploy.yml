name: Deploy to Beget

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: |
        npm ci --legacy-peer-deps
        echo "âœ… Dependencies installed"
    
    - name: Build project
      run: |
        npm run build
        echo "âœ… Build completed"
    
    - name: Verify PWA files
      run: |
        cd dist
        echo "ðŸ“ Files in dist after build:"
        ls -la
        
        echo -e "\nðŸ” Looking for PWA files:"
        find . -name "*.js" -o -name "*.webmanifest" -o -name "*.html" | xargs grep -l "manifest\|register\|service-worker" 2>/dev/null || echo "No PWA files found"
        
        echo -e "\nðŸ“„ Checking for generated files:"
        if [ -f "manifest.webmanifest" ]; then
          echo "âœ… manifest.webmanifest exists"
        else
          echo "âŒ manifest.webmanifest missing"
        fi
        
        if [ -f "registerSW.js" ]; then
          echo "âœ… registerSW.js exists"
        else
          echo "âŒ registerSW.js missing"
        fi
    
    - name: Create .htaccess for Beget
      run: |
        cd dist
        
        # Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ð¹ .htaccess ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ
        rm -f .htaccess
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¹ .htaccess Ð¿Ð¾ ÑÑ‚Ñ€Ð¾ÐºÐ°Ð¼
        echo 'RewriteEngine On' >> .htaccess
        echo 'RewriteBase /' >> .htaccess
        echo '' >> .htaccess
        echo '# Serve existing files and directories' >> .htaccess
        echo 'RewriteCond %{REQUEST_FILENAME} -f [OR]' >> .htaccess
        echo 'RewriteCond %{REQUEST_FILENAME} -d' >> .htaccess
        echo 'RewriteRule ^ - [L]' >> .htaccess
        echo '' >> .htaccess
        echo '# SPA fallback' >> .htaccess
        echo 'RewriteRule ^ index.html [L]' >> .htaccess
        echo '' >> .htaccess
        echo '# MIME TYPES FOR VITE PWA' >> .htaccess
        echo 'AddType application/javascript .js .mjs' >> .htaccess
        echo 'AddType application/wasm .wasm' >> .htaccess
        echo 'AddType text/css .css' >> .htaccess
        echo 'AddType image/jpeg .jpeg .jpg' >> .htaccess
        echo 'AddType image/png .png' >> .htaccess
        echo 'AddType image/svg+xml .svg' >> .htaccess
        echo 'AddType application/json .json' >> .htaccess
        echo 'AddType application/manifest+json .webmanifest' >> .htaccess
        
        echo "âœ… .htaccess created"
        echo -e "\nðŸ“„ .htaccess content:"
        cat .htaccess
    
    - name: Create _redirects for SPA
      run: |
        cd dist
        echo '/*    /index.html   200' > _redirects
        echo "âœ… _redirects created"
    
    - name: Deploy to Beget via FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.0
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./dist/
        server-dir: ${{ secrets.FTP_DIR }}
        dangerous-clean-slate: false
        exclude: |
          **/.git*
          **/.git*/**
          **/.DS_Store